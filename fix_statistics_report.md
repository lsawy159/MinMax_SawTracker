# تقرير إصلاح مشكلة الإحصائيات

## التشخيص النهائي

### المشكلة الأساسية
الإحصائيات تظهر "0" بسبب **عدم وجود بيانات** في جدول `companies` للوصول عبر `anon key` المستخدم في الواجهة.

### الأسباب المكتشفة

#### 1. Row-Level Security (RLS) Policy
- جدول `companies` محمي بـ RLS policy
- `anon key` لا يستطيع قراءة أو إضافة البيانات
- تحتاج إلى تسجيل دخول كـ admin للوصول

#### 2. أعمدة مفقودة
بعد التحقق، الأعمدة الموجودة فعلياً في جدول `companies`:
- ✅ `name` 
- ✅ `unified_number`
- ✅ `commercial_registration_expiry`
- ✅ `insurance_subscription_expiry`

الأعمدة المفقودة التي يحاول الكود استخدامها:
- ❌ `commercial_registration_status` (تحسب تلقائياً)
- ❌ `insurance_subscription_status` (تحسب تلقائياً)
- ❌ `insurance_subscription_number` (بديل: استخدام unified_number)
- ❌ `government_documents_renewal`
- ❌ `max_employees`
- ❌ `muqeem_expiry`

#### 3. بنية الجدول الفعلية
الكود يحاول الوصول لحقول غير موجودة فعلياً، مما يسبب أخطاء في الجلب والتحديث.

## الحل المقترح

### الحل الفوري - إضافة البيانات
قم بتشغيل الـ SQL التالي في **Supabase SQL Editor**:

```sql
-- إضافة الشركات التجريبية
INSERT INTO companies (name, unified_number, commercial_registration_expiry, insurance_subscription_expiry)
VALUES 
  ('شركة محمد النفيعي للتشغيل والصيانة', '7035540473', '2026-01-20', '2026-01-14'),
  ('شركة سواعدنا', '7035540462', '2025-12-25', '2025-12-18'),
  ('شركة حرج - تحتاج متابعة', '1001001', '2025-12-10', '2025-12-08'),
  ('شركة متوسط - متابعة مطلوبة', '1002002', '2025-12-20', '2025-12-15'),
  ('شركة ساري - آمنة', '1003003', '2026-04-15', '2026-04-10'),
  ('شركة منتهي - خطير', '1004004', '2025-11-01', '2025-10-15'),
  ('شركة بدون تواريخ - تحتاج تحديث', '1005005', NULL, NULL);
```

### الحل طويل المدى

#### 1. تسجيل دخول admin
- إنشاء حساب admin في النظام
- تسجيل الدخول للوصول لجدول companies
- إضافة البيانات من الواجهة

#### 2. تحديث الكود
تعديل الكود لاستخدام الحقول الموجودة فقط:
- إزالة المراجع لحقول مفقودة
- حساب الحالات تلقائياً من التواريخ
- إضافة قيم افتراضية للحقول المفقودة

#### 3. إصلاح RLS Policy
تعديل RLS policy للسماح بـ:
- قراءة البيانات للـ anon users
- إضافة الشركات من الواجهة

## النتيجة المتوقعة
بعد إضافة البيانات:
- ✅ الإحصائيات ستظهر "7 إجمالي المؤ" 
- ✅ إحصائيات السجل التجاري: 1 منتهي، 2 حرج، 2 متوسط، 2 ساري
- ✅ إحصائيات التأمين: 1 منتهي، 2 حرج، 2 متوسط، 2 ساري
- ✅ نسبة منتهي الصلاحية: 14% (1 من 7)

## خطوات التنفيذ

1. **افتح Supabase Dashboard** → SQL Editor
2. **انسخ والصق** محتوى ملف `create_sample_companies.sql`
3. **شغل الاستعلام** لإضافة البيانات
4. **حدث الصفحة** في تطبيق SawTracker
5. **تأكد من الإحصائيات** تظهر صحيحة

## ملاحظات
- البيانات المضافة هي تجريبية لأغراض الاختبار
- يمكن حذفها واستبدالها بالبيانات الحقيقية لاحقاً
- الكود يحسب الحالات تلقائياً بناءً على التواريخ
- لا حاجة لتخزين الحالات في قاعدة البيانات